<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard | Subscriptions List</title>
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    </head>
<body class="font-sans gradient-bg text-text-light min-h-screen">

    <header class="main-header">
        <div class="container header-content">
            <h1 class="logo">let's go <span class="logo-white">gym</span></h1>
      
        </div>
    </header>

    <main class="container main-content">
        <div class="dashboard-container">
            
            <div class="status-header">
                <h2 class="text-3xl font-extrabold text-accent-yellow">
                    Membership Lookup
                </h2>
                <p class="text-gray-400 mt-2">Enter the unique subscription code to check status.</p>
            </div>

            <div class="search-area">
                <input type="text" id="search-code-input" placeholder="Enter Subscription Code (e.g., 87654321)" oninput="searchByCode()">
                
                <div id="search-result-container" class="hidden">
                    <h3 class="text-accent-yellow">Found Member: <span id="lookup-name"></span></h3>
                    <div class="lookup-details-grid">
                        <p><strong>Code:</strong> <span id="lookup-code"></span></p>
                        <p><strong>Plan:</strong> <span id="lookup-plan"></span></p>
                        <p><strong>Days Left:</strong> <span id="lookup-days-left"></span></p>
                        <p><strong>Paid:</strong> <span id="lookup-is-paid"></span></p>
                    </div>
                    <button class="cta-button mt-4" onclick="handleTogglePaymentStatus()">
                        <span id="toggle-button-text">Toggle Payment Status</span>
                    </button>
                </div>
                <div id="search-error-message" class="hidden text-red-400 mt-2">
                    Code not found or invalid format.
                </div>
            </div>

            <hr class="my-8 border-gray-700">
            <div class="table-header">
                <h2 class="text-3xl font-extrabold text-white">All Subscriptions</h2>
                <button class="cta-button danger-button" onclick="clearSubscriptions()">Clear All Subscriptions</button>
            </div>
            
            <div class="table-container">
                <table class="subscriptions-table">
                    <thead>
                        <tr>
                            <th>ID  </th>
                            <th>Code  </th>
                            <th>Name  </th>
                            <th>Plan  </th>
                            <th>Paid Status  </th>
                            <th>Days Left  </th>
                            <th>Action  </th>
                        </tr>
                    </thead>
                    <tbody id="subscriptions-table-body">
                        </tbody>
                </table>
            </div>

        </div>
    </main>

    <footer class="main-footer">
        <div class="container footer-content">
            <p>&copy; 2026 let's go gym. all rights reserved. | powered by results.</p>
        </div>
    </footer>
    
    <script type="module" src="firebase-init.js" defer></script>
    <script type="module">
        import { db } from './firebase-init.js';
        import { 
            collection, 
            getDocs, 
            query, 
            where, 
            doc, 
            updateDoc, 
            deleteDoc 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        let currentLookupDoc = null; 
        let currentLookupDocId = null;

        // Utility function to calculate remaining days
        function getSubscriptionStatus(subscription) {
            const oneDayInMilliseconds = 24 * 60 * 60 * 1000;
            // startDate is a timestamp (number), duration is days
            const expiryTimestamp = subscription.startDate + (subscription.duration * oneDayInMilliseconds);
            const timeRemaining = expiryTimestamp - Date.now();
            const daysLeft = Math.ceil(timeRemaining / oneDayInMilliseconds);
            
            return {
                daysLeft: Math.max(0, daysLeft),
                isExpired: daysLeft <= 0
            };
        }

        // --- Main Table Loader ---
        async function loadTable() {
            const tableBody = document.getElementById('subscriptions-table-body');
            tableBody.innerHTML = ''; // Clear existing rows

            try {
                // Firestore Query: Fetch all subscriptions
                const q = query(collection(db, "subscriptions"));
                const querySnapshot = await getDocs(q);

                querySnapshot.forEach(docSnapshot => {
                    const sub = docSnapshot.data();
                    const docId = docSnapshot.id; // Use Firestore document ID
                    const status = getSubscriptionStatus(sub);
                    
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = docId.substring(0, 4) + '...'; // Display truncated ID
                    row.insertCell().textContent = sub.code;
                    row.insertCell().textContent = sub.name;
                    row.insertCell().textContent = sub.plan;
                    
                    // Paid Status Cell
                    const paidStatusCell = row.insertCell();
                    paidStatusCell.textContent = sub.isPaid ? 'YES' : 'NO';
                    paidStatusCell.className = sub.isPaid ? 'text-success' : 'text-danger';
                    
                    // Days Left Cell
                    const daysLeftCell = row.insertCell();
                    daysLeftCell.textContent = status.daysLeft > 0 ? `${status.daysLeft} days` : 'EXPIRED';
                    daysLeftCell.className = status.daysLeft <= 7 && status.daysLeft > 0 ? 'text-warning' : status.daysLeft <= 0 ? 'text-danger' : 'text-success';

                    // Action Cell (Toggle Button)
                    const actionCell = row.insertCell();
                    const toggleButton = document.createElement('button');
                    toggleButton.textContent = sub.isPaid ? 'Mark Unpaid' : 'Mark Paid';
                    toggleButton.className = sub.isPaid ? 'cta-button' : 'cta-button';
                    
                    // Pass the Firestore ID and the current data to the toggle function
                    toggleButton.onclick = () => togglePaymentStatus(docId, sub); 
                    actionCell.appendChild(toggleButton);
                });

            } catch (e) {
                console.error("Error loading table data: ", e);
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7;
                cell.textContent = `Error loading data: ${e.message}`;
                cell.className = 'text-danger';
            }
        }

        // --- Toggle Payment Status ---
        async function togglePaymentStatus(docId, currentData) {
            
            const newIsPaid = !currentData.isPaid;
            let newStartDate = currentData.startDate;

            // If marking paid, update the startDate to now if it's currently expired/unpaid
            if (newIsPaid && (currentData.isPaid === false || getSubscriptionStatus(currentData).isExpired)) {
                 newStartDate = Date.now();
            }

            try {
                const docRef = doc(db, "subscriptions", docId);
                // Firestore Update: Update the subscription record by ID
                await updateDoc(docRef, { 
                    isPaid: newIsPaid,
                    startDate: newStartDate 
                });

                // Reload the entire table to show changes
                await loadTable();
                
                // If this was called from the lookup section, update that as well
                if (currentLookupDocId === docId) {
                    // Update the local object for the lookup display
                    currentLookupDoc.isPaid = newIsPaid;
                    currentLookupDoc.startDate = newStartDate;
                    updateLookupDisplay(currentLookupDoc); 
                }

            } catch (e) {
                console.error("Error toggling payment status: ", e);
                // Note: Using console.error instead of alert due to constraints
                console.error("Error updating payment status. Check console.");
            }
        }

        // --- Search By Code ---
        async function searchByCode() {
            const searchInput = document.getElementById('search-code-input');
            const searchCode = searchInput.value.trim();
            
            const resultContainer = document.getElementById('search-result-container');
            const errorMessage = document.getElementById('search-error-message');
            
            resultContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            currentLookupDoc = null; // Clear previous result
            currentLookupDocId = null;

            if (searchCode.length !== 8 || isNaN(searchCode)) {
                if (searchCode.length > 0) errorMessage.classList.remove('hidden');
                return;
            }

            try {
                // Firestore Query: Filter by code
                const q = query(collection(db, "subscriptions"), where("code", "==", searchCode));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const docSnapshot = querySnapshot.docs[0];
                    currentLookupDoc = docSnapshot.data();
                    currentLookupDocId = docSnapshot.id;
                    updateLookupDisplay(currentLookupDoc);
                    resultContainer.classList.remove('hidden');
                } else {
                    errorMessage.classList.remove('hidden');
                }

            } catch (e) {
                console.error("Error searching by code: ", e);
                errorMessage.textContent = `Search error: ${e.message}`;
                errorMessage.classList.remove('hidden');
            }
        }
        
        // Helper function to update the lookup result area
        function updateLookupDisplay(sub) {
            const status = getSubscriptionStatus(sub);
            
            document.getElementById('lookup-name').textContent = sub.name;
            document.getElementById('lookup-code').textContent = sub.code;
            document.getElementById('lookup-plan').textContent = sub.plan;
            document.getElementById('lookup-days-left').textContent = `${status.daysLeft} days`;
            document.getElementById('lookup-is-paid').textContent = sub.isPaid ? 'YES' : 'NO';
            document.getElementById('lookup-is-paid').className = sub.isPaid ? 'text-success' : 'text-danger';
            
            // Update the toggle button text
            document.getElementById('toggle-button-text').textContent = sub.isPaid ? 'Mark Unpaid' : 'Mark Paid';
            const toggleButton = document.querySelector('#search-result-container button');
            toggleButton.className = sub.isPaid ? 'cta-button mt-4 danger-button' : 'cta-button mt-4';
        }


        // --- Clear All Subscriptions ---
        async function clearSubscriptions() {
            // Note: Replacing window.confirm() with a console log due to environment constraints.
            console.warn("ADMIN ACTION: Starting process to clear ALL subscriptions. This is irreversible."); 
            
            try {
                // Fetch all documents
                const querySnapshot = await getDocs(collection(db, "subscriptions"));
                const deletePromises = [];

                if (querySnapshot.empty) {
                     console.log("No subscriptions found to clear.");
                } else {
                    querySnapshot.forEach(docSnapshot => {
                        deletePromises.push(deleteDoc(doc(db, "subscriptions", docSnapshot.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    console.log(`Successfully deleted ${deletePromises.length} subscriptions.`);

                    // Clear local storage 
                    localStorage.removeItem('currentSubscriptionCode'); 
                    localStorage.removeItem('currentSubscriptionDocId');
                }
                
                // Reload the table
                await loadTable(); 

            } catch (e) {
                console.error("Error clearing subscriptions: ", e);
                // Inform admin via console instead of alert
                console.error(`ACTION FAILED: Error clearing data. Check console for details.`);
            }
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTable();
            // Expose functions globally for HTML attributes (oninput, onclick)
            window.searchByCode = searchByCode; 
            window.clearSubscriptions = clearSubscriptions; 
            window.handleTogglePaymentStatus = function() { // Used by the lookup button
                if (currentLookupDocId && currentLookupDoc) {
                    togglePaymentStatus(currentLookupDocId, currentLookupDoc);
                }
            };
            window.togglePaymentStatus = togglePaymentStatus; // Exposed for the table buttons
        });
    </script>
</body>
</html>
